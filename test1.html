<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>n8n Multi-File Uploader Tool</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 30px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-primary { background-color: #007bff; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-warning { background-color: #ff9800; }
        .btn-warning:hover { background-color: #e68900; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        .status-pending { color: #999; }
        .status-uploading { color: #007bff; font-weight: bold; }
        .status-success { color: #28a745; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }
        #log { margin-top: 20px; background: #222; color: #0f0; padding: 10px; font-family: monospace; height: 150px; overflow-y: scroll; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöÄ C√¥ng c·ª• Test Upload Nhi·ªÅu File</h2>
    
    <div class="form-group">
        <label>1. Webhook URL (n8n):</label>
        <input type="text" id="webhookUrl" placeholder="D√°n link Webhook v√†o ƒë√¢y (VD: https://n8n.docops.me/webhook/...)" value="http://n8n.docsops.me/webhook-test/upload-files">
        <small style="color: #666;">L∆∞u √Ω: N·∫øu d√πng localhost, h√£y ƒë·∫£m b·∫£o n8n ƒëang m·ªü.</small>
    </div>

    <div class="form-group">
        <label>2. Owner ID (Gi·∫£ l·∫≠p User):</label>
        <input type="text" id="ownerId" value="ca272d5d-4e6f-4d82-8383-26581be88221">
    </div>

    <div class="form-group">
        <label>3. Ch·ªçn File (Cho ph√©p ch·ªçn nhi·ªÅu):</label>
        <input type="file" id="fileInput" multiple>
    </div>

    <div class="btn-group">
        <button class="btn-primary" onclick="uploadParallel()">‚ö° G·ª≠i ·ªì ·∫°t (Song song)</button>
        <button class="btn-warning" onclick="uploadQueue()">üê¢ G·ª≠i l·∫ßn l∆∞·ª£t (Queue)</button>
    </div>

    <table id="fileTable">
        <thead>
            <tr>
                <th>T√™n File</th>
                <th>K√≠ch th∆∞·ªõc</th>
                <th>Tr·∫°ng th√°i</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div id="log">Logs s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>
</div>

<script>
    const logDiv = document.getElementById('log');
    
    function log(msg) {
        logDiv.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function getFiles() {
        return Array.from(document.getElementById('fileInput').files);
    }

    function renderTable(files) {
        const tbody = document.querySelector('#fileTable tbody');
        tbody.innerHTML = '';
        files.forEach((file, index) => {
            const row = `<tr>
                <td>${file.name}</td>
                <td>${(file.size / 1024).toFixed(2)} KB</td>
                <td id="status-${index}" class="status-pending">Ch·ªù g·ª≠i...</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    async function uploadSingleFile(file, index, url, ownerId) {
        const statusCell = document.getElementById(`status-${index}`);
        const startTime = Date.now();
        
        // Log khi b·∫Øt ƒë·∫ßu g·ª≠i
        log(`[File ${index + 1}] B·∫Øt ƒë·∫ßu g·ª≠i: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
        statusCell.textContent = "ƒêang g·ª≠i...";
        statusCell.className = "status-uploading";

        const formData = new FormData();
        // Key n√†y ('data') ph·∫£i kh·ªõp v·ªõi c√†i ƒë·∫∑t trong node Webhook n8n
        formData.append('data', file); 
        formData.append('owner_id', ownerId);

        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });

            const endTime = Date.now();
            const duration = ((endTime - startTime) / 1000).toFixed(2);

            if (response.ok) {
                statusCell.textContent = "‚úÖ ƒê√£ g·ª≠i xong";
                statusCell.className = "status-success";
                log(`[File ${index + 1}] ‚úÖ Th√†nh c√¥ng: ${file.name} (${duration}s)`);
            } else {
                throw new Error(response.statusText);
            }
        } catch (error) {
            const endTime = Date.now();
            const duration = ((endTime - startTime) / 1000).toFixed(2);
            statusCell.textContent = "‚ùå L·ªói: " + error.message;
            statusCell.className = "status-error";
            log(`[File ${index + 1}] ‚ùå L·ªói: ${file.name} - ${error.message} (${duration}s)`);
        }
    }

    // C√°ch 1: G·ª≠i ·ªì ·∫°t c√πng l√∫c (Test ch·ªãu t·∫£i)
    async function uploadParallel() {
        const files = getFiles();
        const url = document.getElementById('webhookUrl').value;
        const ownerId = document.getElementById('ownerId').value;

        if (files.length === 0 || !url) { alert("Vui l√≤ng ch·ªçn file v√† ƒëi·ªÅn URL!"); return; }
        renderTable(files);
        log(`B·∫Øt ƒë·∫ßu g·ª≠i song song ${files.length} file...`);

        // Ch·∫°y t·∫•t c·∫£ promise c√πng l√∫c
        const promises = files.map((file, index) => uploadSingleFile(file, index, url, ownerId));
        await Promise.all(promises);
        log("ƒê√£ ho√†n t·∫•t to√†n b·ªô quy tr√¨nh.");
    }

    // C√°ch 2: G·ª≠i l·∫ßn l∆∞·ª£t (An to√†n)
    async function uploadQueue() {
        const files = getFiles();
        const url = document.getElementById('webhookUrl').value;
        const ownerId = document.getElementById('ownerId').value;

        if (files.length === 0 || !url) { alert("Vui l√≤ng ch·ªçn file v√† ƒëi·ªÅn URL!"); return; }
        renderTable(files);
        log(`B·∫Øt ƒë·∫ßu g·ª≠i l·∫ßn l∆∞·ª£t ${files.length} file...`);

        // D√πng v√≤ng l·∫∑p for...of ƒë·ªÉ ƒë·ª£i (await) t·ª´ng c√°i
        for (let i = 0; i < files.length; i++) {
            await uploadSingleFile(files[i], i, url, ownerId);
            log(`ƒêang ch·ªù 1 ch√∫t tr∆∞·ªõc khi g·ª≠i file ti·∫øp theo...`);
            await new Promise(r => setTimeout(r, 1000)); // Ngh·ªâ 1 gi√¢y gi·ªØa c√°c l·∫ßn g·ª≠i
        }
        log("ƒê√£ ho√†n t·∫•t to√†n b·ªô quy tr√¨nh.");
    }
</script>

</body>
</html>